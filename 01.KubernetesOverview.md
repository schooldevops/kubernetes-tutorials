# Kubernetes Overview 

- 쿠버네티스는 강력한 open-source ochestration tool이다. 
- 구글이 만들어 오픈소스화 하였다. 
- 컨테이너화된 어플리케이션들로 구성된 마이크로 서비스를 관리하는 역할을 한다. 
- Kubernetes 는 REST API 와 선언적 매니페스트를 통해서 다양한 리소스를 관리하여, 복잡성을 클러스터 내부로 숨긴다.

## Kubernetes 이점 

- 여러 호스트들 사이에서 컨테이너 오케스트레이션 한다. 
- 리소스를 최대한으로 사용할 수 있도록 하드웨어에 사용 최적화를 수행한다. 
- 정적인 앱을 수행할 수 있도록 스토리지를 추가하고 마운트한다.
- 어플리케이션 배포와 업데이트를 자동화 한다. 
- 리소스에 필요에 따라 컨테이너를 자동확장/축소한다. 
- 배포된 어플리케이션이 안정적으로 수행할 수 있도록 선언적으로 관리한다. 
- 헬스체크를 수행하고, 어플리케이션 자체 헬스체크를 수행한다. 

## Kubernetes Architecture Overview

- Kubernetes 를 활용하기 위해서 기본적인 Kubernetes Architecture를 살펴볼 필요가 있다.

![kubernetes_arch_overview](./imgs/kubernetes_arch_overview.png)

### Kubernetes Cluster

- Kubernetes Cluster는 Kubernetes 를 운영하기 위한 여러 node들의 집합을 말한다. 
- Kubernetes Cluster 구성
  - Master Node (Control Plane): 쿠버네티스를 운영하는 구성요소들이 존재하는 장비를 마스터 노드라고 한다. 
  - Data Node (Data Plane): 실제 어플리케이션 서비스들이 실행되는 장비들을 데이터 노드들이라고 한다. 
- 클러스터 노드는 물리적 장비, 가상장비 (VM), 클라우드 인스턴스들이 될 수 있다. 

## Master Node (Control Plane)

- 마스터 노드는 Control Plane로 불린다. 
- Control Plane 구성 요소는 다음과 같다. 
  - API Server
  - ETCD
  - Scheduler
  - Controller Manager
  - Cloud Controller Manager 
- 마스터노드는 여러 컴포넌트및 노드들을 관리한다. 
  - 마스터 노드에 존재하는 Pod들 관리 
  - Data Node 관리 
  - Data Node의 Pod 관리 
- 마스터 노드역시 고 가용성을 위해 여러대의 노드로 구성된다. 
- 마스터 노드는 DevOps로 부터 오퍼레이션 요청을 받아 클러스터를 운영하고, 서비스 Pod등을 운영하게 된다. 
- 마스터 노드는 안정성을 위해 Control Plane 요소만 관리를 원칙으로 한다. 

## Data Nodes 

- 워커노드, 데이터노드 등으로 불린다. 
- 워커노드는 고 가용성을 위해 1대 이상의 장비로 구성된다. 
- 장비는 물리적 장비, 가상장비 (VM), 클라우드 인스턴스들이 될 수 있다. 
- 어플리케이션 (서비스) 들은 Data Node에 Pod라는 최소 단위로 배포가 된다. 
- Pod에는 하나 이상의 컨테이너가 배치 된다. 
- 시스템의 구모에 따라 Scale In/Out, Scale Up/Down 을 수행하여 오퍼레이션 할 수 있다. 

## Master Node 구성요소 

- 마스터 노드는 Kubernetes Cluster에서 두뇌를 담당한다. 
- 마스터 노드는 각 구성요소들을 활용하여 pod의 배치, 노드의 상태관리, 항상성 유지등을 수행한다. 

### API Server 

- API 서버는 Kubernetes를 운영하기 위한 API를 제공하는 서버이다. 
- 또한 모든 통신은 API 서버를 통해 이루어진다. 
- API 서버는 모든 클러스터 컴포넌트를 추적하고, 관리하는 역할을 한다. 
- 요청은 YAML/JSON 매니페스트를 이용한다. 

### ETCD 

- 분산, 고가용성 키-값 저장소이다. 
- 모든 쿠버네티스 클러스터 메타정보(클러스터 상태, 설정정보) 를 저장하고 관리한다. 
- 모든 클러스터의 정보는 ETCD에서 관리한다. (Source of truth)
- 오직 API 서버에서만 접근이 가능하다. 
- Control Plane 내부에 ETCD가 설치 될수도 있고, 외부 machine을 두어 분리 관리도 가능하다. 

### Scheduler

- POD를 어떤 노드에 배포되어야할지 스케줄 한다. 
- API 서버에 아직 할당되지 않은 POD를 검색하고, Node들의 상태를 감시하여 적절한 노드를 찾을 수 있도록 한다. 
- API 서버에 주기적으로 변경사항을 감시하는 일을 수행한다.
- 스케줄링 고려사항 :
  - 필요한 자원
  - 하드웨어/소프트웨어/정책 등 
  - Affinity, anti-affinity 
  - Data 위치 
  - 워크로드 사이에 간섭 여부 
  - Taint, Toleration
  
### Controller Manager 

- 컨테이너 객체의 상태를 감시한다. 
- API Server에 요청하여 해당 상태를 확인한다. 
- 컨테이너 객체가 요구한 상태인지 확인하고, 해당 상태가 될 수 있도록 조정작업을 한다. 
- yml파일이 변경되면 해당 변경사항에 따라 클러스터내 컨테이너를 관리한다. 
- 종류
  - Replication Controller: POD의 복제 수를 관리한다. 
  - Endpoint Controller: 서비스와 pod와 같은 엔드포인트를 배포한다. 

### Cloud Controller Manager 

- 클러스터 내부에서 클라우드 기술과 통합하는 역할을 한다. 
- 클러스터가 클라우드에서 동작한다면 Cloud Controller Manager이 사용된다. 
- CSP에 따라 다른 Cloud Controller Manager를 제공한다. 
- Cloud Controller Manager는 Cloud가 제공하는 API와 통신한다. 
  - 라우트, 로드밸런스, 볼륨등 클라우드 인프라 리소스와 연동하여 동작하도록 한다. 

## Data Node 

- 각 노드는 다양한 컴포넌트들이 수행되며, 실행중인 pod와 환경변수등을 제공한다. 

### Kubelet 

- 클러스터 Data Node 각각에 설치되어 있는 Agent이다. 
- API 서버에 Data Node 정보를 API 서버로 보낸다. 
- POD들의 실행상태를 체크한다. 
- POD의 인스턴스를 실행한다. 
- API 서버를 확인하고, 작업요청이 잇는경우 태스크 수행작업을 수행한다. 
- 마스터로 부터 지시를 받고, 메트릭을 반환한다. 

### kube-proxy

- 네트워크를 담당하며, 네트워킹의 핵심 임무를 수행한다. 
- IP 변환, 라우팅을 수행한다. 
- 클러스터 각 노드마다 수행되며 네트워크 프록시 역할을 한다. 
- 노드의 네트워크 룰을 관리한다. 이들은 Pod간 통신, 외부와의 통신을 수행한다. 
- 각 POD는 유니크한 IP 주소를 가지게 된다. 이를 통해서 POD와 통신이 가능하다. 
- 쿠버네티스 네트워킹 서비스를 촉진시키고 서비스에서 모든 파드사이에 로드밸런싱을 수행한다. 

### POD 

- 배포되는 최소단위이다. 
- POD에는 1개 이상의 컨테이너가 실행된다. 
- POD마다 고유의 IP를 가진다. 

## 기타 구성요소

- Registry 
  - 컨테이너 리포지토리로 이미지를 관리한다. 
  - Docker Hub, ECR, 자체관리 Repository 
- Networking
  - Cilium, Calico 프로젝트가 있다. 
- Telemetry
  - Prometheus와 Elastic Stack 와 같은 프로젝트를 이용할 수 있다.
- Security
  - LDAP, RBAC, SELinux, OAuth 를 포함하는 광범위한 옵션이 가능하다. 
- Package management
  - Helm 패키지 관리자를 통해서 어플리케이션을 패키지화 하고, 클러스터에 쉽게 배포할 수 있다. 
- Container Storage Interface (CSI)
  - Kubernetes 와 통합하여 저장소로 언티페이스 할 수 있는 표준 인터페이스 제공 
- Container Networking Interface (CNI)
  - Kubernetes cluster 에서 네트워킹 리소스 설정을 동적으로 수행할 수 있도록 한다. 

## Kubernetes 보안 

- Kubernetes 은 다양한 보안 기능을 제공한다. 
- 그러나 Kubernetes는 기본적으로 안전하지 않다. 
- 보안 관점 3가지 

### 빌드 과정에서 이미지 보안 

- 최근 CI/CD 개발 라이프 사이클에서 개발자는 코드를 작성하고, CI/CD 파이프라인에 보낸다. 
- 그리고 어후 컨테이너 이미지화 된다. 
- 이 부분에서 보안이 매우 중요한 포인트가 된다. 이미지가 빌드될때, 그리고 리포지토리에 있는 이미지들에 대해서 보안 취약 검사가 필요하다. 

### 프로덕션에서 네트워크 보안 

- 실행 환경에서 네트워크 보안인 중요한 포인트이다. 
- 쿠버네티스에서 CNI를 이용하여 보안 네트워크 레이어를 생성하고, 각 쿠버네티스 네임스페이스에서 private subnet 제공하건ㅏ, 컨테이너간의 통신에 대해서 제약을 통해 이를 달성할 수 있다. 

### 쿠버네티스 보안 설정  

- 쿠버네티스의 유연성은 뛰어나며, 이들로 인해서 보안을 지키는 것이 쉽지 않다. 
- 보안 설정에 대한 다양한 베스트 프랙티스를 익힐 필요가 있다. 

